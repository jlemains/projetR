---
title: "Projet R - Cours Outils et M√©thodologie"
author: "Thomas FONTAINE, Dan GOLDMAN, Juliette LEMAINS, Nicolas ROBIN"
date: "12/01/2019"
always_allow_html: yes
output:
  html_document: default
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                      echo=TRUE, warning=FALSE, message=FALSE)
```


**Objectif du projet :**

* Manipuler et analyser de la Data sous R.

* Programmer en R

* Sortir un rapport en utilisant R-Markdown


**Contexte :**
Une soci√©t√© X a envoy√© ses donn√©es clients ainsi que ses achats sur l'ann√©e N-2 (2016) et N-1 (2017).
Le but est de sortir un rapport d‚Äô√©tude 

**Dur√©e :**
Rapport et programme √† retourner pour le 13 janvier 2019 au plus tard.

**Les donn√©es :**
Les tables mises √† disposition sont structur√©es de la mani√®re suivante :

![](structure.png)

# √ânonc√©

# 1 - √âtude globale

## 1.1	R√©partition Adh√©rant / VIP ....

Constituer un camembert suivant la r√©partition suivante :

*	*VIP* : client √©tant VIP (VIP = 1)

*	*NEW_N2* : client ayant adh√©r√© au cours de l'ann√©e N-2 (date d√©but adh√©sion)

*	*NEW_N1* : client ayant adh√©r√© au cours de l'ann√©e N-1 (date d√©but adh√©sion)

*	*ADHERANT* : client toujours en cours d'adh√©sion (date de fin d'adh√©sion > 2018/01/01)

*	*CHURNER* : client ayant churner (date de fin d'adh√©sion < 2018/01/01)


*Note : le crit√®re le plus au-dessus est prioritaire, exemple : un client √©tant VIP, et ayant adh√©r√© sur l'ann√©e N-1 sera compt√© comme √©tant VIP*

## 1.2	Comportement du CA GLOBAL par client N-2 vs N-1

Constituer une boite √† moustache pour chaque ann√©e (N-2 et N-1) comparant le CA TOTAL (TTC) des clients (sommer les achats par client par ann√©es)

## 1.3	R√©partition par √¢ge x sexe

Constituer un graphique montrant la r√©partition par age x sexe sur l'ensemble des clients.
		

# 2 -	√âtude par magasin

## 2.1	R√©sultat par magasin (+ 1 ligne Total)

Constituer un tableau (formattable) reprenant les donn√©es suivantes :

* *MAGASIN*

* *NOMBRE DE CLIENTS RATTACHES AU MAGASIN* (avec une color_bar en fonction de la quantit√©)

* *NOMBRE DE CLIENTS ACTIFS sur N-2*

* *NOMBRE DE CLIENTS ACTIFS sur N-1*

* *% CLIENT N-2 vs N-1* (couleur police : vert si positif, rouge si n√©gatif)

* *TOTAL_TTC N-2*

* *TOTAL_TTC N-1*

* *Diff√©rence entre N-2 et N-1* (couleur police : vert si positif, rouge si n√©gatif)

* *Indice √©volution *(ic√¥ne de satisfaction : positif si le pourcentage de clients actifs √©volue et total TTC aussi, n√©gatif si il y a une diminution des 2 indicateurs, moyen si seulement l'un des deux diminue)

*Note --> on effectuera un tri sur l'indice d'√©volution : les positifs en haut, les n√©gatifs en bas.*

## 2.2	Distance CLIENT <-> MAGASIN

L'objectif est de calculer la distance qui existe entre le magasin et le client.

Les informations disponibles sont :

*	*la ville du magasin*

*	*le code INSEE du client*

Il faut t√©l√©charger les donn√©es GPS des villes et code-insee pour pouvoir calculer la distance :\
https://public.opendatasoft.com/explore/dataset/correspondance-code-insee-code-postal

Une fois les donn√©es acquises, il faut :

* lier les donn√©es GPS compos√© de la latitude et de la longitude au client et au magasin.

* constituer pour chaque client et chaque magasin 2 colonnes : latitude et longitude.

* cr√©er une fonction qui d√©termine la distance entre 2 points.

La fonction doit prendre 4 variables en compte : latitude1, longitude1, latitude2, longitude2.\
Pour savoir si la fonction est correcte : https://www.lexilogos.com/calcul_distances.htm

Constituer une repr√©sentation (tableau ou graphique --> au choix) repr√©sentant le nombre de client par distance :

* *0 √† 5km*

* *5 √† 10km*

* *10 √† 20km*

* *20 √† 50km*

* *plus de 50km*

# 3 - Etude par univers

## 3.1 Evolution du CA par univers

Constituer un histogramme N-2 / N-1 affichant l'√©volution du CA par univers

## 3.2	Top par univers

Afficher le top 5 des familles les plus rentable par univers (en fonction de la marge obtenu) (tableau ou graphique -> au choix)

---

# Programmation R


### Pr√©ambule

La consigne de ce projet √©tait la cr√©ation et l'utilisation de 3 fichiers :

* le fichier "Parametres.R"

* le fichier "Projet.R"

* le fichier "Projet.Rmd"

Dans le cadre de cette exigence, nous avons mis toutes les constantes et variables du projet dans le fichier "Parametres.R".
Nous avons aussi ajout√© dans ce fichier, et comme cela l'a √©t√© demand√©, les fonctions de chargement des tables.

Nous avons ensuite fait le choix de d√©couper le projet en diff√©rentes fonctions ind√©pendantes, de mani√®re √† faciliter l'organisation du travail en √©quipe. 7 fonctions ont √©t√© cr√©es, soit 1 fonction par exercice demand√© :

* repartition_adherant_vip_1.1

* comportement_CA_1.2

* proportion_sexe_age_1.3

* resultat_magasin_2.1

* distance_Client_Magasin_2.2

* etude_par_univers_3.1

* top_par_univers_3.2


Dans le m√™me esprit, les fichiers ont √©t√© charg√©es sur [GitHub](https://github.com/jlemains/projetR) pour favoriser le travail en groupe.

Si vous d√©sirez obtenir des informations suppl√©mentaires sur chacune des fonctionnalit√©s d√©velopp√©es dans le code, des commentaires d√©taill√©s ont √©t√© inclus dans le code source des fichiers "Parametres.R" et "Projet.R".

### Mise en place de l'environnement de travail

Chargement du fichier param√®tres qui permet :

* le chargement des biblioth√®ques n√©cessaires √† l'ex√©cutuon des scripts R de ce fichier.

* le chargement des variables des fichiers.

* le chargement des tables.

# 1 - Etude globale

Les fonctions permettant de r√©pondre aux probl√©matiques sont charg√©es dans le fichier "Projet.R"" :

```{r Chargement_des_fonctions_projet}
source("Projet.R")
```
Nous importons le fichier "Parametres.R" dans le fichier "Projet.R", ce fichier d√©clare les diff√©rents param√®tres (bases de donn√©es, variables, etc.).

C'est aussi dans ce fichier que les tables sont charg√©es en m√©moire.


## 1.1	R√©partition Adh√©rant / VIP ....

La fonction qui suit permet de g√©n√©rer un camembert repr√©sentant la r√©partition des clients VIP, adh√©rents au cours de N-1, adh√©rant au cours de N-2 et les churner. Il a bien entendu fallu, dans la d√©finition de la fonction, g√©rer les clients qui appartiennent √† deux ensembles.

```{r Exercice_1.1_repartition_adherant_vip}
repartition_adherant_vip_1.1(ANNEE_EN_COURS,convert_date_client(clients))
```

## 1.2	Comportement du CA GLOBAL par client N-2 vs N-1

Cette fonction repr√©sente deux boites √† moustache repr√©sentants les CA par clients sur l'ann√©e N-1 et N-2. Lors de la d√©finition de cette fonction, il a fallu exclure les valeurs aberrantes qui biaisaient √©norm√©ment la r√©partition.
```{r Exercice_1.2_comportement_CA}
comportement_CA_1.2(ANNEE_EN_COURS,entetes)
```

## 1.3	R√©partition par √¢ge x sexe

La population √©tudi√©e dans cette fonction est l'ensemble des hommes et des femmes dont les ages sont renseign√©s et sont compris entre 18 et 98 ans. La fonction cr√©√© deux graphiques, le premier repr√©sentant d'un cot√© la r√©partition des femmes par rapport aux femmes et de l'autre cot√© des hommes par rapport aux hommes. Le second graphique repr√©sente les tranches d'age des femmes et les tranches d'age des hommes par rapport √† la population totale.

```{r Exercice_1.3_Proportion_sexe_age}
proportion_sexe_age_1.3(clients)
```

# 2 -	√âtude par magasin

## 2.1	R√©sultat par magasin (+ 1 ligne Total)

Cette fonction etudie les revenues et le nombre de client des magasins, ainsi que l'evolution entre l'annee 2016 et 2017.
```{r Exercice_2.1_Resultat_magasin}
resultat_magasin_2.1(ANNEE_EN_COURS,clients, magasins, entetes)
```

## 2.2	Distance CLIENT <-> MAGASIN

#### Cette partie du projet a √©t√© divis√©e en 7 √©tapes distinctes.

**√âtape 1 : Construction et pr√©paration de la "TABLE_DE_TRAVAIL"**

Cette table est une *version am√©nag√©e et simplifi√©e de la table de correspondance de l'INSEE*.
Elle r√©cup√®re uniquement les 4 colonnes qui nous int√©ressent : CODEINSEE, Code Postal, Commune et geo_point_2d.

**√âtape 2 : Phase de traitement des donn√©es et r√©tablissement de la coh√©rence des donn√©es.**

Cette phase permet de r√©tablir la coh√©rence entre les tables "TABLE_DE_TRAVAIL, MAGASINS et CLIENTS

Par exemple :

* On retire tous les tirets "-" dans les nom des villes afin de ramener de la coh√©rence dans le champ VILLE de la "TABLE DE TRAVAIL" issue du fichier CODE INSEE et celui de la table "MAGASINS".

* On remplace tous les "ST" par "SAINT", toujours pour amener de la coh√©rence entre les villes de la "TABLE DE TRAVAIL" issues du fichier CODE INSEE et celle list√©es dans la table "MAGASINS".

* On retire le mot "CEDEX" trouv√© dans certains noms de villes.

**√âtape 3 : Jointure entre les tables "MAGASINS" et "TABLE DE TRAVAIL" avec mise en forme de la table nouvellement cr√©√©.**

On cr√©e une nouvelle table "jointureGeoMagasins" avec jointure (left join) entre la table MAGASINS et la "TABLE DE TRAVAIL". Cette nouvelle table est ensuite mise en forme. Cette mise en forme inclut le renommage de certaines colonnes et l'ajout des informations manquantes de localisation dans la table MAGASINS pour la ville "LES MILLES" qui n'est pas r√©pertori√©e dans le tableau de l'INSEE.

**√âtape 4 : Jointure entre les tables "CLIENTS" et "TABLE DE TRAVAIL" avec mise en forme de la table nouvellement cr√©√©.**

On cr√©e une table "jointureGeoClients"" avec jointure (left join encore une fois) entre la table CLIENTS et la TABLE DE TRAVAIL, elle est ensuite mise en forme.

**√âtape 5 : Jointure entre les tables "jointureGeoMagasins" et "jointureGeoClients".**

Cette jointure finale "jointureGeoMagasinsClients" va permettre d'effectuer le calcul de la distance entre chacun des clients de l'enseigne et le magasin dans lequel ils sont inscrits.

**√âtape 6 : Calcul de la distance.**

Pour le calcul de la distance entre 2 points g√©ographiques, on a cr√©√© la fonction **distanceGeo((lat1, lon1, lat2, lon2)**.
Cette fonction utilise la [FORMULE DE HAVERSINE](https://fr.wikipedia.org/wiki/Formule_de_haversine) en l'√©tat.
Elle renvoie *exactement* les m√™mes valeurs que celles retourn√©es sur le site [LEXILOGOS](https://www.lexilogos.com/calcul_distances.htm).

**√âtape 7 : Affichage du r√©sultat au format tableau**

Une fois la distance calcul√©e pour chaque client, et apr√®s que l'affectation des modalit√©s aux distances D1 √† D6 ait √©t√© effectu√©e, nous affichons les r√©sultats de la table "jointureGeoMagasinsClients" dans une figure au format tableau, en utilisant la library formattable.

```{r Exercice_2.2_Distance_Client_Magasin}
distance_Client_Magasin_2.2(insee, magasins, clients)
```

Nous avons remarqu√© que sur l'ensemble des 845876 individus de la base clients, 9598 d'entre eux (soit un peu plus de 1%) ont renseign√© une adresse postale se trouvant √† plus de 200 kilom√®tres de leur lieu d'achat. Il y a de fortes chances pour que le client ait transmis le code postal de sa ville natale ou bien le client √©tait de passage.

Par exemple, le client pour lequel on obtient la distance la plus √©lev√©e (9393,7602 km) a transmis le code postal de [Saint-Andr√©e](https://www.google.com/destination/map/topsights?q=saint-Andr%C3%A9+r%C3%A9union&site=search&output=search&dest_mid=/m/0dhd3c&sa=X&ved=2ahUKEwjguMGi9OffAhUNJBoKHW3IDVoQ69EBKAEwAXoECAAQBA#trifp=skpm%3D/g/1yl45x9bm) sur √Æle de la R√©union. √áa au moins le m√©rite de nous faire voyager ! üòÅ

En bref, nous avons d√©cid√© pour cette √©tude, de conserver ces 9508 clients √† l'int√©rieur de la modalit√© "D5 - plus de 50 km" dans la mesure o√π il est impossible de savoir si il s'agit r√©ellement de l'adresse r√©elle du client ou pas‚Ä¶ Lors d‚Äôune pr√©sentation de ce rapport aux responsables de l'enseigne, il sera n√©cessaire de leur transmettre cette information.

# 3 - Etude par univers

## 3.1 Evolution du CA par univers

Cette fonction permet d'afficher un histogramme presentant le CA par univers produit et par ann√©e d'achat.

Concernant le p√©rim√®tre des donn√©es, nous privilegions des jointures internes entre les tables, permettant de determiner si l'unification des donn√©es engendre une perte de volumetrie.

Le constat d'analyse est le suivant :

* Un article vendu de la table "ligne" n'est pas r√©f√©renc√© dans la table "article". Nous avons donc fait le choix de rajouter ce dernier afin de ne pas perdre l'information lors de l'agr√©gation des donn√©es (cette article a √©t√© nomm√© "unknown dans la table article")

* Tous les articles n'ayant pas √©t√© vendus (√† savoir non pr√©sent dans la table ligne) sont exclus de l'analyse.

```{r Exercice_3.1_Etude_par_univers}
etude_par_univers_3.1(articles,lignes,entetes)
```

## 3.2	Top 5 des familles les plus rentable par univers

Cette fonction permet d'afficher un graphe representant un top 5 des familles les plus rentable par univers.

Concernant le p√©rim√®tre des donn√©es, nous privil√©gions d'afficher tous les articles, m√™me si ces derniers n'ont pas g√©n√©r√©s de marge.

Le constat d'analyse est le suivant :

* Certains articles n'ont pas √©t√© vendus (√† savoir non pr√©sent dans la table ligne)

* La marge a √©t√© forc√©e √† 0 pour tous ces articles non vendus.

```{r Exercice_3.2_Top_par_univers}
top_par_univers_3.2(articles,lignes)
```
